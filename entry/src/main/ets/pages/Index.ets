import { FoodStore } from '../store/FoodStore';
import { UserManager } from '../store/UserManager';
import { TodayRecommendPage } from './TodayRecommendPage';
import { FoodListPage } from './FoodListPage';
import { HistoryPage } from './HistoryPage';
import { StatsPage } from './StatsPage';
import { SettingsPage } from './SettingsPage';
import router from '@ohos.router';

@Entry
@Component
struct Index {
  @StorageLink('foodStore') foodStore: FoodStore | null = null;
  @StorageLink('currentTabIndex') currentTabIndex: number = 0;
  @State currentUser: string = '';
  private userManager: UserManager = UserManager.getInstance();
  
  async aboutToAppear() {
    const context = getContext(this) as Context;
    
    // ä¿å­˜ context åˆ° AppStorageï¼Œä¾›å…¶ä»–é¡µé¢ä½¿ç”¨
    AppStorage.setOrCreate('context', context);
    
    // åˆå§‹åŒ–UserManager
    await this.userManager.init(context);
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    const isLoggedIn = await this.userManager.isLoggedIn();
    if (!isLoggedIn) {
      // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
      router.replaceUrl({
        url: 'pages/LoginPage'
      });
      return;
    }
    
    // è·å–å½“å‰ç”¨æˆ·å
    this.currentUser = await this.userManager.getCurrentUser();
    
    // åˆå§‹åŒ– FoodStoreï¼ˆä¼ å…¥ç”¨æˆ·åï¼‰
    const store = new FoodStore(context);
    await store.init(this.currentUser);
    
    // å­˜å‚¨åˆ° AppStorage
    AppStorage.setOrCreate('foodStore', store);
    this.foodStore = store;
  }

  @Builder TabBuilder(index: number, name: string, icon: string) {
    Column() {
      Text(icon)
        .fontSize(22)
        .margin({ bottom: 2 })
      Text(name)
        .fontSize(10)
        .fontColor(this.currentTabIndex === index ? '#ff6b6b' : '#666')
    }
    .width('20%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.currentTabIndex = index;
    })
  }

  build() {
    Column() {
      // TabContent åŒºåŸŸ
      Column() {
        if (this.currentTabIndex === 0) {
          TodayRecommendPage()
        } else if (this.currentTabIndex === 1) {
          FoodListPage()
        } else if (this.currentTabIndex === 2) {
          HistoryPage()
        } else if (this.currentTabIndex === 3) {
          StatsPage()
        } else if (this.currentTabIndex === 4) {
          SettingsPage()
        }
      }
      .width('100%')
      .layoutWeight(1)
      
      // åº•éƒ¨ TabBar
      Row() {
        this.TabBuilder(0, 'æ¨è', 'ğŸ½ï¸')
        this.TabBuilder(1, 'èœå“', 'ğŸ“‹')
        this.TabBuilder(2, 'å†å²', 'ğŸ“…')
        this.TabBuilder(3, 'ç»Ÿè®¡', 'ğŸ“Š')
        this.TabBuilder(4, 'è®¾ç½®', 'âš™ï¸')
      }
      .width('100%')
      .height(56)
      .backgroundColor('#fff')
      .shadow({ radius: 8, color: '#00000010', offsetY: -2 })
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .height('100%')
  }
}