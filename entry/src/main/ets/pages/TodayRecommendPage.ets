import { FoodStore } from '../store/FoodStore';
import { FoodItem, MealType } from '../model/FoodItem';
import { getTodayDate, getCurrentMealType } from '../common/dateUtils';
import { getMealTypeName, getPriceLevelSymbol, getOriginName } from '../common/constants';
import { getTodayFestival, Festival, getLunarDateString } from '../common/festivals';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import Want from '@ohos.app.ability.Want';

@Component
export struct TodayRecommendPage {
  @StorageLink('foodStore') foodStore: FoodStore | null = null;
  @State currentMealType: MealType = MealType.Lunch;
  @State recommendation: FoodItem | null = null;
  @State showRecommendation: boolean = false;
  @State showMeituanDialog: boolean = false;
  @State currentFestival: Festival | null = null;
  @State lunarDateStr: string = '';
  
  aboutToAppear() {
    // æ ¹æ®å½“å‰æ—¶é—´è‡ªåŠ¨è®¾ç½®é¤åˆ«
    const currentMeal = getCurrentMealType();
    this.currentMealType = currentMeal as MealType;
    
    // æ£€æµ‹å½“å‰èŠ‚æ—¥
    this.currentFestival = getTodayFestival();
    
    // è·å–å†œå†æ—¥æœŸ
    this.lunarDateStr = getLunarDateString();
  }
  
  // è·å–æ¨è
  handleGetSuggestion() {
    if (this.foodStore) {
      const result = this.foodStore.getSuggestion(this.currentMealType);
      if (result) {
        this.recommendation = result;
        this.showRecommendation = true;
      } else {
        // æ²¡æœ‰å¯æ¨èçš„èœå“
        promptAction.showToast({ message: 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„èœå“ï¼Œè¯·æ£€æŸ¥è®¾ç½®æˆ–æ·»åŠ æ›´å¤šèœå“' });
      }
    }
  }
  
  // æ¢ä¸€ä¸ª
  handleChangeOne() {
    this.handleGetSuggestion();
  }
  
  // å°±åƒå®ƒ
  async handleConfirm() {
    if (this.foodStore) {
      await this.foodStore.confirmSuggestion(this.currentMealType);
      promptAction.showToast({ message: 'å·²è®°å½•åˆ°å†å²ï¼' });
      this.showMeituanDialog = true;
    }
  }
  
  // æ‰“å¼€ç¾å›¢æœç´¢
  async openMeituan() {
    if (this.recommendation) {
      const foodName = this.recommendation.name;
      const url = `imeituan://www.meituan.com/search?q=${encodeURIComponent(foodName)}`;
      
      try {
        const context = AppStorage.get<common.UIAbilityContext>('context');
        if (context) {
          const want: Want = {
            action: 'ohos.want.action.viewData',
            uri: url
          };
          await context.startAbility(want);
        }
      } catch (err) {
        promptAction.showToast({ message: 'æœªå®‰è£…ç¾å›¢æˆ–æ‰“å¼€å¤±è´¥' });
      }
    }
    this.showMeituanDialog = false;
    this.showRecommendation = false;
    this.recommendation = null;
  }
  
  // å–œæ¬¢
  async handleLike() {
    if (this.foodStore) {
      await this.foodStore.likeCurrent();
      promptAction.showToast({ message: 'å·²æå‡è¯¥èœå“çš„æ¨èæƒé‡ï¼' });
    }
  }
  
  // ä¸å†æ¨è
  async handleDislike() {
    if (this.foodStore) {
      await this.foodStore.dislikeCurrent(this.currentMealType);
      promptAction.showToast({ message: 'å·²æ ‡è®°ä¸ºä¸å†æ¨èï¼' });
      this.showRecommendation = false;
      this.recommendation = null;
    }
  }
  
  @Builder MeituanDialog() {
    Column() {
      Text('ğŸ´')
        .fontSize(48)
        .margin({ bottom: 15 })
      
      Text('æ˜¯å¦æ‰“å¼€ç¾å›¢æœç´¢ï¼Ÿ')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 10 })
      
      if (this.recommendation) {
        Text(`æœç´¢â€œ${this.recommendation.name}â€`)
          .fontSize(14)
          .fontColor('#666')
          .margin({ bottom: 25 })
      }
      
      Row() {
        Button('ä¸ç”¨äº†')
          .fontSize(16)
          .backgroundColor('#f0f0f0')
          .fontColor('#333')
          .layoutWeight(1)
          .onClick(() => {
            this.showMeituanDialog = false;
            this.showRecommendation = false;
            this.recommendation = null;
          })
        
        Button('æ‰“å¼€ç¾å›¢')
          .fontSize(16)
          .backgroundColor('#ff6b6b')
          .fontColor('#fff')
          .layoutWeight(1)
          .margin({ left: 10 })
          .onClick(() => this.openMeituan())
      }
      .width('100%')
    }
    .width('80%')
    .padding(25)
    .backgroundColor('#fff')
    .borderRadius(15)
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨æ—¥æœŸå’Œé¤åˆ«
      Column() {
        // é˜³å†æ—¥æœŸ
        Text(getTodayDate())
          .fontSize(16)
          .fontColor('#999')
          .margin({ top: 20 })
        
        // å†œå†æ—¥æœŸ
        if (this.lunarDateStr) {
          Text(`å†œå† ${this.lunarDateStr}`)
            .fontSize(13)
            .fontColor('#bbb')
            .margin({ top: 5 })
        }
        
        Text(getMealTypeName(this.currentMealType))
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 10 })
        
        // èŠ‚æ—¥æç¤º
        if (this.currentFestival) {
          Row() {
            Text(this.currentFestival.emoji)
              .fontSize(16)
              .margin({ right: 5 })
            Text(`${this.currentFestival.name} Â· ${this.currentFestival.description}`)
              .fontSize(14)
              .fontColor('#ff6b6b')
          }
          .padding({ left: 15, right: 15, top: 8, bottom: 8 })
          .backgroundColor('#fff0f0')
          .borderRadius(20)
          .margin({ top: 15 })
        }
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
      
      // é¤åˆ«åˆ‡æ¢
      Row() {
        Button('æ—©é¤')
          .type(ButtonType.Capsule)
          .backgroundColor(this.currentMealType === MealType.Breakfast ? '#ff6b6b' : '#f0f0f0')
          .fontColor(this.currentMealType === MealType.Breakfast ? '#fff' : '#333')
          .fontSize(12)
          .onClick(() => {
            this.currentMealType = MealType.Breakfast;
            this.showRecommendation = false;
          })
        
        Button('åˆé¤')
          .type(ButtonType.Capsule)
          .backgroundColor(this.currentMealType === MealType.Lunch ? '#ff6b6b' : '#f0f0f0')
          .fontColor(this.currentMealType === MealType.Lunch ? '#fff' : '#333')
          .fontSize(12)
          .margin({ left: 8 })
          .onClick(() => {
            this.currentMealType = MealType.Lunch;
            this.showRecommendation = false;
          })
        
        Button('ä¸‹åˆèŒ¶')
          .type(ButtonType.Capsule)
          .backgroundColor(this.currentMealType === MealType.AfternoonTea ? '#ff6b6b' : '#f0f0f0')
          .fontColor(this.currentMealType === MealType.AfternoonTea ? '#fff' : '#333')
          .fontSize(12)
          .margin({ left: 8 })
          .onClick(() => {
            this.currentMealType = MealType.AfternoonTea;
            this.showRecommendation = false;
          })
        
        Button('æ™šé¤')
          .type(ButtonType.Capsule)
          .backgroundColor(this.currentMealType === MealType.Dinner ? '#ff6b6b' : '#f0f0f0')
          .fontColor(this.currentMealType === MealType.Dinner ? '#fff' : '#333')
          .fontSize(12)
          .margin({ left: 8 })
          .onClick(() => {
            this.currentMealType = MealType.Dinner;
            this.showRecommendation = false;
          })
        
        Button('å¤œå®µ')
          .type(ButtonType.Capsule)
          .backgroundColor(this.currentMealType === MealType.Supper ? '#ff6b6b' : '#f0f0f0')
          .fontColor(this.currentMealType === MealType.Supper ? '#fff' : '#333')
          .fontSize(12)
          .margin({ left: 8 })
          .onClick(() => {
            this.currentMealType = MealType.Supper;
            this.showRecommendation = false;
          })
      }
      .margin({ top: 30 })
      
      // ä¸­éƒ¨æ¨èå¡ç‰‡
      Column() {
        if (this.showRecommendation && this.recommendation) {
          // æ˜¾ç¤ºæ¨èç»“æœ
          Column() {
            Text(this.recommendation.name)
              .fontSize(36)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 20 })
            
            // æ ‡ç­¾
            Row() {
              ForEach(this.recommendation.tags, (tag: string) => {
                Text(tag)
                  .fontSize(14)
                  .padding({ left: 10, right: 10, top: 5, bottom: 5 })
                  .backgroundColor('#e8f5e9')
                  .borderRadius(12)
                  .margin({ right: 8 })
              })
            }
            .margin({ bottom: 15 })
            
            // ä»·æ ¼å’Œæ¥æº
            Row() {
              Text(getPriceLevelSymbol(this.recommendation.priceLevel))
                .fontSize(16)
                .fontColor('#ff9800')
                .margin({ right: 15 })
              
              Text(getOriginName(this.recommendation.origin))
                .fontSize(16)
                .fontColor('#666')
            }
            .margin({ bottom: 20 })
            
            // æ“ä½œæŒ‰é’®
            Row() {
              Button('âœ… å°±åƒå®ƒ')
                .fontSize(14)
                .backgroundColor('#4caf50')
                .onClick(() => this.handleConfirm())
              
              Button('â¤ï¸ å–œæ¬¢')
                .fontSize(14)
                .backgroundColor('#ff4081')
                .margin({ left: 10 })
                .onClick(() => this.handleLike())
              
              Button('ğŸš« ä¸å†æ¨è')
                .fontSize(14)
                .backgroundColor('#9e9e9e')
                .margin({ left: 10 })
                .onClick(() => this.handleDislike())
            }
          }
          .width('90%')
          .padding(30)
          .backgroundColor('#fff')
          .borderRadius(20)
          .shadow({ radius: 10, color: '#00000020' })
        } else {
          // å ä½å›¾
          Column() {
            Text('ğŸ½ï¸')
              .fontSize(80)
              .margin({ bottom: 20 })
            
            Text('ä»Šå¤©åƒä»€ä¹ˆï¼Ÿ')
              .fontSize(24)
              .fontColor('#999')
          }
          .width('90%')
          .height(300)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#fafafa')
          .borderRadius(20)
        }
      }
      .layoutWeight(1)
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      
      // åº•éƒ¨æŒ‰é’®
      Button('å¸®æˆ‘é€‰ï¼')
        .width('80%')
        .height(50)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .backgroundColor('#ff6b6b')
        .margin({ bottom: 30 })
        .onClick(() => this.handleGetSuggestion())
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
    .bindSheet(this.showMeituanDialog, this.MeituanDialog(), {
      height: 280,
      backgroundColor: Color.Transparent,
      showClose: false,
      onDisappear: () => {
        this.showMeituanDialog = false;
      }
    })
  }
}
