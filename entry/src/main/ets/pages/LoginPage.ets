import { UserManager } from '../store/UserManager';
import promptAction from '@ohos.promptAction';
import router from '@ohos.router';

@Entry
@Component
struct LoginPage {
  @State username: string = '';
  @State password: string = '';
  @State isLogin: boolean = true; // true=ç™»å½•æ¨¡å¼, false=æ³¨å†Œæ¨¡å¼
  @State isLoading: boolean = false;
  private userManager: UserManager = UserManager.getInstance();
  
  async handleSubmit() {
    if (this.isLoading) return;
    
    this.isLoading = true;
    
    try {
      if (this.isLogin) {
        // ç™»å½•
        const result = await this.userManager.login(this.username, this.password);
        if (result.success) {
          promptAction.showToast({ message: result.message });
          // è·³è½¬åˆ°ä¸»é¡µ
          router.replaceUrl({
            url: 'pages/Index'
          });
        } else {
          promptAction.showToast({ message: result.message });
        }
      } else {
        // æ³¨å†Œ
        const result = await this.userManager.register(this.username, this.password);
        if (result.success) {
          promptAction.showToast({ message: result.message + 'ï¼Œè¯·ç™»å½•' });
          this.isLogin = true;
          this.password = '';
        } else {
          promptAction.showToast({ message: result.message });
        }
      }
    } finally {
      this.isLoading = false;
    }
  }
  
  build() {
    Column() {
      // Logoå’Œæ ‡é¢˜
      Column() {
        Text('ðŸ½ï¸')
          .fontSize(64)
          .margin({ bottom: 20 })
        
        Text('ä»Šå¤©åƒä»€ä¹ˆ')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 10 })
        
        Text(this.isLogin ? 'ç™»å½•æ‚¨çš„è´¦å·' : 'æ³¨å†Œæ–°è´¦å·')
          .fontSize(14)
          .fontColor('#999')
      }
      .margin({ top: 100, bottom: 60 })
      
      // è¾“å…¥æ¡†
      Column() {
        // ç”¨æˆ·å
        Column() {
          Text('ç”¨æˆ·å')
            .fontSize(14)
            .fontColor('#333')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 8 })
          
          TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å', text: this.username })
            .height(48)
            .fontSize(16)
            .backgroundColor('#f5f5f5')
            .borderRadius(8)
            .onChange((value) => {
              this.username = value;
            })
        }
        .width('100%')
        .margin({ bottom: 20 })
        
        // å¯†ç 
        Column() {
          Text('å¯†ç ')
            .fontSize(14)
            .fontColor('#333')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 8 })
          
          TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ', text: this.password })
            .height(48)
            .fontSize(16)
            .type(InputType.Password)
            .backgroundColor('#f5f5f5')
            .borderRadius(8)
            .onChange((value) => {
              this.password = value;
            })
        }
        .width('100%')
        .margin({ bottom: 30 })
        
        // æäº¤æŒ‰é’®
        Button(this.isLogin ? 'ç™»å½•' : 'æ³¨å†Œ')
          .width('100%')
          .height(48)
          .fontSize(16)
          .backgroundColor('#ff6b6b')
          .borderRadius(8)
          .enabled(!this.isLoading)
          .opacity(this.isLoading ? 0.6 : 1)
          .onClick(() => this.handleSubmit())
        
        // åˆ‡æ¢æ¨¡å¼
        Row() {
          Text(this.isLogin ? 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ' : 'å·²æœ‰è´¦å·ï¼Ÿ')
            .fontSize(14)
            .fontColor('#666')
          
          Text(this.isLogin ? 'ç«‹å³æ³¨å†Œ' : 'ç«‹å³ç™»å½•')
            .fontSize(14)
            .fontColor('#ff6b6b')
            .margin({ left: 5 })
            .onClick(() => {
              this.isLogin = !this.isLogin;
              this.password = '';
            })
        }
        .margin({ top: 20 })
      }
      .width('85%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#fff')
  }
}
