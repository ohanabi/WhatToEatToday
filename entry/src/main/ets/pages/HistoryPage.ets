import { FoodStore } from '../store/FoodStore';
import { HistoryItem } from '../model/HistoryItem';
import { getMealTypeName } from '../common/constants';
import { formatDate } from '../common/dateUtils';

@Component
export struct HistoryPage {
  @StorageLink('foodStore') foodStore: FoodStore | null = null;
  @State selectedDate: string = '';
  
  // æŒ‰æ—¥æœŸåˆ†ç»„å†å²è®°å½•
  getGroupedHistory(): Map<string, HistoryItem[]> {
    if (!this.foodStore) return new Map();
    
    const grouped = new Map<string, HistoryItem[]>();
    
    // è¿‡æ»¤å’Œåˆ†ç»„
    let history = this.foodStore.history.filter(item => item.confirmed);
    
    if (this.selectedDate) {
      history = history.filter(item => item.date === this.selectedDate);
    }
    
    // æŒ‰æ—¥æœŸåˆ†ç»„ï¼Œå€’åºæ’åˆ—
    history.sort((a, b) => b.date.localeCompare(a.date));
    
    history.forEach(item => {
      if (!grouped.has(item.date)) {
        grouped.set(item.date, []);
      }
      grouped.get(item.date)!.push(item);
    });
    
    return grouped;
  }
  
  // è·å–æ‰€æœ‰æ—¥æœŸåˆ—è¡¨ï¼ˆç”¨äºç­›é€‰ï¼‰
  getAllDates(): string[] {
    if (!this.foodStore) return [];
    
    const dates = new Set<string>();
    this.foodStore.history.forEach(item => {
      if (item.confirmed) {
        dates.add(item.date);
      }
    });
    
    return Array.from(dates).sort((a, b) => b.localeCompare(a));
  }
  
  build() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('å†å²è®°å½•')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        // æ˜¾ç¤ºå†å²è®°å½•æ€»æ•°
        Text(`å…±${this.foodStore?.history.length || 0}æ¡`)
          .fontSize(14)
          .fontColor('#666')
          .margin({ right: 10 })
        
        if (this.selectedDate) {
          Button('æ¸…é™¤ç­›é€‰')
            .fontSize(14)
            .backgroundColor('#9e9e9e')
            .onClick(() => {
              this.selectedDate = '';
            })
        }
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 20, bottom: 10 })
      
      // æ—¥æœŸç­›é€‰ï¼ˆç®€å•çš„æŒ‰é’®åˆ—è¡¨ï¼‰
      if (!this.selectedDate && this.getAllDates().length > 0) {
        Column() {
          Text('å¿«é€Ÿç­›é€‰æ—¥æœŸ')
            .fontSize(14)
            .fontColor('#666')
            .alignSelf(ItemAlign.Start)
            .margin({ left: 20, bottom: 10 })
          
          Scroll() {
            Row() {
              ForEach(this.getAllDates().slice(0, 10), (date: string) => {
                Button(formatDate(date))
                  .fontSize(12)
                  .backgroundColor('#e3f2fd')
                  .fontColor('#1976d2')
                  .margin({ right: 8 })
                  .onClick(() => {
                    this.selectedDate = date;
                  })
              })
            }
            .padding({ left: 20, right: 20 })
          }
          .scrollable(ScrollDirection.Horizontal)
          .scrollBar(BarState.Off)
          .width('100%')
        }
        .margin({ bottom: 15 })
      }
      
      // å†å²è®°å½•åˆ—è¡¨
      if (this.getGroupedHistory().size === 0) {
        Column() {
          Text('ğŸ“')
            .fontSize(60)
            .margin({ bottom: 10 })
          Text('æš‚æ— å†å²è®°å½•')
            .fontSize(16)
            .fontColor('#999')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        List({ space: 15 }) {
          ForEach(Array.from(this.getGroupedHistory().entries()), (entry: [string, HistoryItem[]]) => {
            ListItem() {
              Column() {
                // æ—¥æœŸæ ‡é¢˜
                Row() {
                  Text(formatDate(entry[0]))
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#ff6b6b')
                  
                  Text(entry[0])
                    .fontSize(12)
                    .fontColor('#999')
                    .margin({ left: 10 })
                }
                .width('100%')
                .margin({ bottom: 10 })
                
                // è¯¥æ—¥æœŸä¸‹çš„è®°å½•
                Column({ space: 8 }) {
                  ForEach(entry[1], (item: HistoryItem) => {
                    Row() {
                      Column() {
                        Text(item.foodName)
                          .fontSize(16)
                          .fontWeight(FontWeight.Medium)
                        
                        Text(getMealTypeName(item.mealType))
                          .fontSize(12)
                          .fontColor('#666')
                          .margin({ top: 3 })
                      }
                      .alignItems(HorizontalAlign.Start)
                      .layoutWeight(1)
                      
                      // ç‚¹èµ/è¸©é›·çŠ¶æ€
                      if (item.liked) {
                        Text('â¤ï¸')
                          .fontSize(20)
                      }
                      if (item.disliked) {
                        Text('ğŸš«')
                          .fontSize(20)
                      }
                    }
                    .width('100%')
                    .padding(12)
                    .backgroundColor('#fafafa')
                    .borderRadius(8)
                  })
                }
              }
              .width('100%')
              .padding(15)
              .backgroundColor('#fff')
              .borderRadius(10)
            }
          })
        }
        .width('90%')
        .layoutWeight(1)
        .margin({ top: 10, left: '5%', right: '5%' })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }
}
